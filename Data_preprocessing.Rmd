---
title: "Data_preprocessing"
author: "Alisa Selezneva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(readxl)
library(foreign)

base_path <- "/Public Health Hackathon 2025/"
```


Preprocessing of Terapia intensiva_analiza_tot.xlsx

```{r}

n_tot <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/Terapia intensiva_analiza_tot (2).xlsx")

# n_tot

```

Columns were translated and reorganized:
- id

- Virsta – Aging	

- Description – Diagnosis description	

- Code – Diagnosis code (ICD-10)		

- sex	 – Diagnosis gender

- Name – Outcome

```{r}
n_tot <- n_tot %>%
  select(id, virsta,
         'Description...4',	Code, sex, Name) %>% 
  rename(Aging = virsta, ICD10 = Code, Description = 'Description...4',
         Gender = sex, Outcome = Name)
```

Outcomes were recoded as following:

 - "externat"  "externat la cerere", "transfer inter-spitalicesc" meaning "discharged" as  "0"

 - "Decedat in Reanimare", "decedat in sectie",        
 "Decedat in TI BCV", Decedat in TI",             
 "Decedat in Zona Rosie",  "Decedat in TI2" meaning "Dead" as 1

```{r}
n_tot <- n_tot %>% 
  mutate(Outcome = case_when(Outcome == "externat" | 
                               Outcome == "externat la cerere" | 
                               Outcome == "transfer inter-spitalicesc" ~ 0,
                             
                             Outcome == "Decedat in Reanimare" |  
                               Outcome == "decedat in sectie" | 
                               Outcome == "Decedat in TI BCV" |  
                               Outcome == "Decedat in TI" |             
                               Outcome == "Decedat in Zona Rosie" |   
                               Outcome == "Decedat in TI2" ~ 1))
  
```

Main file sepsis.csv:

```{r}
sepsis <- read_csv("Public Health Hackathon 2025/Public Health Hackathon 2025/sepsis.csv")
sepsis <- sepsis %>% rename(id = record_id)
```


```{r}
sepsis_df <- left_join(sepsis, n_tot)
```

Laboratory analyses files preprocessing:

```{r}

TI_analize2015 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2015") %>% 
  select(-nume)
TI_analize2016 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2016") %>% 
  select(-nume)
TI_analize2017 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2017") %>% 
  select(-nume)
TI_analize2018 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2018") %>% 
  select(-nume)
TI_analize2019 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2019") %>% 
  select(-nume)
TI_analize2020 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2020") %>% 
  select(-nume)
TI_analize2021 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2021") %>% 
  select(-nume)

TI_analize2022_25 <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/TI_analize.xlsx", sheet = "2022-2025") %>% 
  select(-nume)

TI_analize <- rbind(TI_analize2015,
                    TI_analize2016,
                    TI_analize2017,
                    TI_analize2018,
                    TI_analize2019,
                    TI_analize2020,
                    TI_analize2021,
                    TI_analize2022_25)

TI_analize <- TI_analize %>% 
  rename(Category = Name, 
         Name = name,
         Date = AppliedDate) %>% 
  select(id, FO, Date, Category, Name, Value)
unique(TI_analize$Category)


```

Renaming columns to unify data sets:

```{r}
tot_analize <- read_excel("Public Health Hackathon 2025/Public Health Hackathon 2025/Terapia intensiva_analiza_tot (2).xlsx", 
    sheet = "Analize de laborator")
tot_analize <- tot_analize %>% 
  rename(Category = 'Name...3', 
         Name = 'Name...6',
         Value = StringValue) %>%
  select(-`(No column name)`,
         id, FO, Date, Category, Name, Value)
unique(tot_analize$Name)
unique(tot_analize$Category)

```

```{r}
analysis_df <- rbind(TI_analize, tot_analize)
unique(analysis_df$Name)
# unique(analysis_df$Category)

write.csv(analysis_df, "analysis_df.csv")
```

Translation of unique necessary terms from Romanian to English:

```{r}
analize <- c(
  "Determinarea  MRS",
  "Inceput",
  "Dozarea hemoglobinei",
  "Numaratoarea eritrocitelor",
  "Oua de helminti",
  "Hematocritul",
  "Protozoare",
  "Numaratoarea leucocitelor",
  "Nesegmentate",
  "Segmentate",
  "Dozarea glucozei",
  "Limfocite",
  "Monocite",
  "D-dimeri",
  "Viteza de sedimentare a hematiilor",
  "Determinarea timpului de coagulare a sangelui Lee-Wait",
  "Indice de culoare",
  "Numaratoarea trombocitelor",
  "Mielocite",
  "Fibrinogenul",
  "Dozarea proteinei totale",
  "Dozarea ureei",
  "Dozarea creatininei in ser sau urina",
  "Anizocitoza (macrocite, microcite, megalocite)",
  "Dozarea bilirubinei",
  "Poikilocitoza",
  "Dozarea bilirubina conjugata",
  "Bilirubina libera",
  "Dozarea alaninaminotransferazei (ALT) in ser",
  "Dozarea aspartataminotransferazei (AST) in ser",
  "Dozarea a-amilazei in lichidele biologice (mat. cinetica)",
  "Eozinofile",
  "Dozarea fosfatazei alcalina in ser",
  "Dozarea g-glutamintranspepsidazei (g-GTP) in ser",
  "Dozarea beta-lipoproteinelor",
  "Reactia",
  "Culoarea",
  "Transparenta",
  "Densitatea relativa",
  "Leucocite",
  "Eritrocite  nemodificate",
  "Eritrocite  modificate",
  "Epiteliu plat",
  "Oxalati de calciu",
  "Indexul protrombinic",
  "Raportul International Normalizat (INR)",
  "Proteine in urina",
  "Testul cu etanol",
  "Determinarea timpului de singerare",
  "Bazofilei",
  "Determinarea hemoglobinei",
  "Grupa de sange determinata",
  "Rhessus apartenenta",
  "Antigen KELL",
  "Mucozitati",
  "Glucoza in urina",
  "Bacterii",
  "Celule plasmatice",
  "Policromatofilia",
  "Eritro-normoblasti (la 100 leucocite)",
  "Cilindri hialini",
  "Uratul de amoniu",
  "Metamielocite",
  "Cilindri granulosi",
  "Timpul de tromboplastina  partial active  (TTPA)",
  "Timpul de trombina (TT)",
  "Granulatie toxica",
  "Dozarea albuminei in ser",
  "Dozarea acidului uric",
  "Dozarea colesterolului",
  "Dozarea trigliceridelor",
  "Hipersegmentarea nucleelor",
  "Determinarea complexelor fibrin-monomerice solubile",
  "Dozarea amilazei singei (amid. plas)",
  "Sfarsit",
  "Fosfati",
  "Urati",
  "Tripelfosfati",
  "Proba cu timol",
  "Corpi cetonici",
  "Determinarea troponinei T in ser",
  "Cilindri leucocitari",
  "Cantitatea",
  "Culoarea pina la centrifugare",
  "Culoarea dupa centrifugare",
  "Transparenta pina la centrifugare",
  "Transparenta dupa centrifugare",
  "Reactia Pandi",
  "Proteine",
  "Citoza:",
  "Eritrocite ne schimbate",
  "Bacilul Koch  (BAAR)",
  "Cristale acid uric",
  "Dozarea potasiului in serul sanguin",
  "Dozarea sodiului in serul sanguin",
  "Dozarea calciului in serul sanguin",
  "Dozarea fosforului",
  "Dozarea clorului in serul sanguin",
  "Epiteliu de tranzitie",
  "Dozarea lactatdehidrogenazei (LDH) in ser",
  "Antitrombina III",
  "Numaratoarea reticulocitelor",
  "PSA",
  "Anizocromie",
  "Neutrofile %",
  "Limfocite %",
  "Eritrocite schimbate",
  "Dozarea ferului in ser",
  "Determinarea antistreptolizinei O  (ASL-O)",
  "Determinarea proteinei C-reactive",
  "Determinarea factorului reumatic",
  "Cilindri epiteliali",
  "Epiteliu renal",
  "HBsAG",
  "Anti HCV sumar",
  "Celule blastice",
  "Timpul de trombina cu sulfat de protamina",
  "Anticoagulantul lupic",
  "Eritrocite neschimbate",
  "Dozarea lipazei",
  "Corpusculi Jolly, inete Cabot",
  "Acizi biliari",
  "Dozarea magneziul",
  "Epiteliu",
  "Epiteliu v",
  "Leucocite v",
  "Microflora",
  "Microflora v",
  "Trichomonas",
  "Trichomonas v",
  "Gonococi",
  "Gonococi v",
  "Cercetarea lichidului cefalo-rahidian",
  "Determinarea  TPHA",
  "Cilindri pigmentari",
  "Lipide",
  "Cilindri cirosi",
  "Bilirubina",
  "Activitatea fibrinolitica",
  "Adeziunea trombocitelor",
  "Anti Xa activitatea heparinei",
  "Reactia la sange",
  "Dozarea creatinfosfokinazei (CK) in ser",
  "Eritrocite cu granulatie bazofila",
  "Levuri",
  "Levuri v",
  "Cilindri eritrocitari",
  "Celule levurice",
  "Nitrati",
  "Timpul de recalcificare activat (TRA)",
  "Dozarea glucozei in sange",
  "Dozarea amilazei urinei (amid. plas)",
  "Indican",
  "Megaloblasti",
  "Timpul de coagulare",
  "Dozarea hemoglobinei glicolizate",
  "HDL colesterol",
  "LDL colesterol",
  "Procalcitonina",
  "1",
  "1d",
  "1c",
  "2",
  "2d",
  "2c",
  "3",
  "3d",
  "3c",
  "4",
  "4d",
  "4c",
  "5",
  "5d",
  "5c",
  "6",
  "6d",
  "6c",
  "7",
  "7d",
  "7c",
  "8",
  "8d",
  "8c",
  "Diureza de zi",
  "Diureza de noapte",
  "Diureza totala",
  "Determinarea pigmentilor biliari in urina",
  "Reactia Rivali",
  "Eritrocite",
  "Din ele neutrofile",
  "Celule  mezoteliale",
  "Celule atipice",
  "Dozarea izoenzimei MB-creatinfosfokinazei (CK-MB)",
  "Urobilinoizi",
  "Proba-trombotest dupa Ita",
  "Eritrocite v",
  "Dozarea proteinei  totale",
  "Dozarea creatininei",
  "Dozarea ALT (alaninaminotransferazei)",
  "Dozarea AST (aspartataminotransferazei)",
  "Determinarea feritinei",
  "Timpul de singerare (Proba Duke)",
  "Liza euglobulinica stimulata de fasa XII-a",
  "Antihialuronidaza",
  "Reactie la corpi cetonici",
  "MRS",
  "Continutul mediu de hemoglobina",
  "Glucoza",
  "Devierea standarda a eritrocitelor",
  "Coeficientul de variatie a eritrocitelor",
  "Aspartal-aminotransferaza ASAT",
  "Procentul macrotrombocitelor",
  "Volum mediu eritrocite",
  "Volumul mediu al trombocitelor total",
  "Bilirubina directa",
  "Devierea trombocitelor",
  "Alanin-aminotransferaza ALAT",
  "Bilirubina indirecta",
  "Bilirubina totala",
  "Acid Uric_corm",
  "Viteza de sedimentare a hematiilor B F",
  "Continutul mediu de hemoglobina intr-un eritrocit",
  "Proteina totala",
  "Uree",
  "Calciu ionizat",
  "Calciu Total",
  "Creatinina",
  "Trigliceride",
  "Acid Uric",
  "Cl",
  "Fier",
  "K",
  "Fosfor",
  "Na",
  "Glutamiltranspeptidaza(GGTP)",
  "Albumine",
  "Colesterol total",
  "Amilaza",
  "Figrinogen Secunde",
  "D-Dimer",
  "Timpul de trombina",
  "Timpul de tromboplastina partial activa",
  "Figrinogen",
  "Complexe fibrin-monomer solubile",
  "Activitatea protrombinei dupa Quick",
  "Anizocitoza",
  "Densitate Relativa",
  "RET-HE",
  "DELTA-HE",
  "HFR",
  "Eritrocite nemodificate",
  "RBC-HE",
  "RET#",
  "HYPO-HE",
  "HYPER-HE",
  "Eritrocite modificate",
  "IRF",
  "RET%",
  "MFR",
  "LFR",
  "CK-MB",
  "Myo",
  "ß-lipoproteide",
  "Rh factor",
  "Factor Kell",
  "cTnI",
  "Grupa sanguina",
  "Glucoza din deget",
  "Determinarea Procalcitoninei",
  "Fosfataza alcalina",
  "Transparenta dupa centriguare",
  "Culoarea pana la centrifugare",
  "Transparenta pana la centrifugare",
  "Citoza",
  "PSA Total",
  "TTPA-Timpul de tromboplastina partial active",
  "Raportul international normalizat (INR)",
  "HBsAg",
  "Lactat dehidrogenaza",
  "anti-HCV",
  "Bilirubina Indirecta",
  "Bilirubina Totala",
  "Determinarea antistreptolizinei-O",
  "Bilirubina Directa",
  "Proteina Totala",
  "Bazofile",
  "Creatinkinaza",
  "Cl-",
  "Dozarea aspartataminotransferazei(AST) in ser",
  "K+",
  "Dozarea bilirubinei conjugate",
  "Na+",
  "Dozarea alaninaminotransferazei(ALT) in ser",
  "Dozarea creatininei in ser",
  "VSH",
  "Amilaza in urina",
  "PCT",
  "Eritro-normoblasti(la 100 leucocite)",
  "Oua de helminti prezente",
  "Creatinkinaza-MB",
  "hs-CRP+CRP",
  "Magneziu",
  "MCHC",
  "PDW",
  "WBC",
  "RDW-S",
  "HCT",
  "MCV",
  "RBC",
  "P-LCR",
  "PLT",
  "HGB",
  "MPV",
  "MCH",
  "Bacilulu Koch(BAAR)",
  "HDL-Colesterol",
  "R0",
  "LDL-Colesterol",
  "- microcite",
  "Hiprocromie",
  "- macrocite",
  "Secret prelevat din",
  "BNP",
  "Locul punctiei",
  "Calciu",
  "Determinare timpului de coagulare",
  "Ca2+",
  "Fibrinogen",
  "INR",
  "Clor",
  "HIV",
  "Numar registru",
  "Consistenta",
  "Miros",
  "Reactia la sangele ocult",
  "Forma",
  "Reactie",
  "Resuri de alimente indigerabile",
  "Fibre musculare fara striatii",
  "Mucozitate",
  "NT-proBNP",
  "pH",
  "Celule mezoteliale",
  "Promielocite",
  "LDL-C",
  "Valoare IgM",
  "Test IgG",
  "Test IgM",
  "Valoare IgG",
  "Sodiu",
  "Potasiu",
  "HDL-C",
  "Saruri",
  "Anti Tg",
  "TSH",
  "T3",
  "T4",
  "CRP",
  "Ferritin",
  "HBsAg-l",
  "Anti-HCV Sumar",
  "AMY DAC",
  "Anti-TPO",
  "Interleukin-6",
  "RDW-C",
  "80/3",
  "HbA1c",
  "734/3",
  "712/3",
  "550/3",
  "685/3",
  "687/3",
  "Cantitate",
  "678/3",
  "717/3",
  "418/3",
  "690/3",
  "683/3",
  "220/3",
  "BASO%",
  "(Fara valoare)",
  "EO%",
  "Comentarii",
  "Activitatea protrombinei dupa Quick sec",
  "Lipide in urina",
  "FT4",
  "FT3",
  "Hypochromia",
  "502",
  "501",
  "UA",
  "ALP",
  "Fe",
  "Ca",
  "GGT"
)

hematology_keywords <- c(
  "eritrocit", "leucocit", "trombocit", "hemoglob", "hematocrit", "reticulocit",
  "anizocitoza", "poikilocitoza", "limfocit", "monocit", "eozinofil", "bazofil",
  "neutrofil", "vsh", "viteza de sedimentare", "indice de culoare", "granulatie",
  "blastice", "megaloblast", "mielocit", "metamielocit", "promielocit", "normoblast",
  "policromatofilia", "jolly", "cabot", "hipocrom", "hipercrom", "macro", "micro",
  "rdw", "mcv", "mch", "mchc", "hct", "mpv", "pdw", "plt", "wbc", "hgb", "rbc"
)

coagulation_keywords <- c(
  "coagulare", "timpul de trombina", "timpul de singerare", "trombotest",
  "timpul de recalcificare", "ttpa", "inr", "protrombin", "fibrinogen", "antitrombina",
  "fibrinolitic", "d-dimer", "complexe fibrin", "adeziunea trombocitelor", "quick"
)

biochemistry_keywords <- c(
  "glucoz", "ure", "creatinin", "biliru", "alt", "ast", "transaminaza", "amilaz", "lipaz",
  "fosfataz", "ggtp", "colesterol", "triglicerid", "albumin", "acid uric", "fer", "ldh",
  "electrolit", "sodiu", "potasiu", "clor", "calciu", "magneziu", "fosfor", "lactat", "protein"
)

filter_by_keywords <- function(tests, keywords) {
  tests[sapply(tolower(tests), function(x) any(grepl(paste(keywords, collapse = "|"), x)))]
}

hematology_tests   <- filter_by_keywords(analize, hematology_keywords)
coagulation_tests  <- filter_by_keywords(analize, coagulation_keywords)
biochemistry_tests <- filter_by_keywords(analize, biochemistry_keywords)

```

Transfers of patients data:

```{r}
transfers <- read_csv("Public Health Hackathon 2025/Public Health Hackathon 2025/Transfers.csv")

sepsis_trans_df <- left_join(transfers, sepsis_df)
```

Interim data sets:

```{r}
write.table(analysis_df, "analyses.csv", 
            sep = ",",  
            row.names = FALSE, 
            col.names = TRUE)

write.table(sepsis_trans_df, "sepsis_trans.csv", 
            sep = ",", quote = FALSE,
            row.names = FALSE, 
            col.names = TRUE)
```

